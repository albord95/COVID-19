# model-SIR-by-region-bayes

Fit the bare SIR with least squares and gaussian priors. The uncertainties on
the data are Poisson but the uncertainties on the results are rescaled with
`sqrt(chi^2 / dof)`.

## Running the fit

Run `fitlsq.py`. You have to specify at least a command line argument:

```
fitlsq.py weakpop|truepop
```

You you specify `weakpop`, the prior on the population of the regions is very
weak, so the fit will find an "effective population" that suits the SIR.
Instead if you specify `truepop` the population is fixed to the true population.

By default `fitlsq.py` fits all regions. You can specify a subset of regions
on the command line:

```
fitlsq.py weakpop|truepop Veneto Umbria Puglia ...
```

## Plotting and predictions

`lsqfit.py` will produce a file named `fitlsq_something.pickle`. Run
`fitlsqplot.py <file generated by fitlsq>` to make the plots, which will be
saved in the directory `fitlsqplot/`. Run `fitlsqpred.py <etc.pickle>` to
compute predictions for the next two weeks and save them in `../predictions/`.

The file saved into `predictions` will be `model-SIR-by-region-bayes.csv` is
the prior setting was `weakpop`, and `model-SIR-region-truepop.csv` if the
prior setting was `truepop`.

There will be both predictions in `dati-regioni` and
`dati-andamento-nazionale`. The national predictions are obtained by summing
all the regional predictions, not by a direct fit.

## Setting the last date

To set the last date it takes from the data, set the environment variable
`LASTDATE`. IPython example:

```
import os
os.environ['LASTDATE'] = '2020-XX-XX'
%run fitlsq.py etc.
```

Shell example:

```
LASTDATE=2020-XX-XX python3 fitlsq.py etc.
```

## Programs list

  * `fitlsq.py`: regularized least squares fit. A sort of approximate bayesian
    fit.

  * `fitlsqplot.py`: plot `fitlsq.py` output.
  
  * `fitlsqpred.py`: write prediction `.csv` files.
  
  * `fitlsqdefs.py`: common stuff for `fitlsq*`.
    
  * `fitmap.py`: maximum a posteriori fit.
    
  * `fitmapplot.py`: plot `fitmap.py` output.
    
  * `plotregions.py`: single plot with all the regions.
    
  * `namedate.py`: just a function to make timestamps.
